#The last stretch!

#Glue everything together
#Start by replacing the stress markers with IPA ones
define IPAStress "'" -> "ˈ" .o. "''" -> "ˌ";

#Delete all of our markers
define DeleteMarkers ["@"|",@"|"#"|",#"|":"|"|"|"*"|"_"|"&"|"%"|"!"|"+"] -> 0;

define Phase311 IPAStress .o. DeleteMarkers;

#And pstprocess the IPA result
#Remove double consonants
#annoyingly I can't think of a better way than this
#so I autogenerated a rule which removes all doubles
source double_rule_gen.foma
#Apply it a few times to ditch triples etc
define MultReplace DoubleReplace .o. DoubleReplace .o. DoubleReplace;

#Schwa when r/rs is at the end of a segment
#NOTE: deleted upside down R from this list
define ConsSound ["p"|"b"|"m"|"ʙ"|"ɸ"|"β"|"ɱ"|"ⱱ"|"f"|"v"|"ʋ"|"θ"|"ð"|"t"|"d"|"n"|"r"|"ɾ"|"s"|"z"|"ɬ"|"ɮ"
                    |"ɹ"|"l"|"ʃ"|"ʒ"|"ʈ"|"ɖ"|"ɳ"|"ɽ"|"ʂ"|"ʐ"|"ɻ"|"ɭ"|"c"|"ɟ"|"ɲ"|"ç"|"ʝ"|"j"|"ʎ"|"k"|"ɡ"
                        |"ŋ"|"x"|"ɣ"|"ɰ"|"ʟ"|"q"|"ɢ"|"ɴ"|"ʀ"|"χ"|"ħ"|"ʕ"|"ʔ"|"h"|"ɦ"|"ʍ"|"w"|"ɥ"|"ʜ"|"ɺ"|"ɧ"];
define VowelSound ["i"|"y"|"ɨ"|"ʉ"|"ɯ"|"u"|"ɪ"|"ʏ"|"ʊ"|"e"|"ø"|"ɘ"|"ɵ"|"ɤ"|"o"|"ə"|"ɛ"|"œ"|"ɜ"|"ɞ"|"ʌ"
                    |"ɔ"|"æ"|"ɐ"|"a"|"ɶ"|"ɑ"|"ɒ"];
define SB12 [.#.|"-"];

define SchwaR [..] -> "ɘ" || ConsSound _ "ɹ" (["s"|"z"]) SB12;
define DelSegMarkers "-" -> 0;

#I prefer a british accent
#This isn't being especially helpful
#define AccRep  "ɹ" -> 0 || _ \VowelSound ,,
#                "ʁ" -> "ə" "ɹ" || _ VowelSound ,,
#                "ʁ" -> "ə" || _ \VowelSound ,,
#                "o" "ʊ" -> "ə" "ʊ";

#This is me just picking random sounds to make ATT TTS work
define AccRep "ɒ" -> "ɔ" .o. "o" "ʊ" -> "ə" "ʊ";

#deal with j
define STM ["ˈ" | "ˌ"];
define ChJ "j" -> 0 || ["r"|"l"|"ʃ"|"t" "ʃ"|"ʒ"|"d" "ʒ"] (STM) _ "u" "ː";

#wrap it up
#FOMA chokes a bit, MultReplace is a 1M FSM
define Phase312a MultReplace;
define Phase312b SchwaR .o. AccRep .o. ChJ .o. DelSegMarkers;
define Phase312c MultReplace;
